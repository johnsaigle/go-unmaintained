# Example workflow for posting PR comments with dependency check results
name: PR Dependency Check

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  check-and-comment:
    name: Check Dependencies and Comment on PR
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Check for unmaintained dependencies
        id: check
        uses: ./.github/actions/check
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          max-age: 365
          check-outdated: true
          fail-on-found: false  # Don't fail, just report
          verbose: true
      
      - name: Comment on PR
        if: steps.check.outputs.unmaintained-count > 0
        uses: actions/github-script@v7
        with:
          script: |
            const results = JSON.parse(process.env.RESULTS);
            const unmaintainedCount = ${{ steps.check.outputs.unmaintained-count }};
            const directCount = ${{ steps.check.outputs.direct-count }};
            const indirectCount = ${{ steps.check.outputs.indirect-count }};
            
            let comment = '## ðŸ” Unmaintained Dependencies Report\n\n';
            comment += `Found **${unmaintainedCount}** unmaintained packages:\n`;
            comment += `- ðŸ”´ **${directCount}** direct dependencies\n`;
            comment += `- ðŸŸ¡ **${indirectCount}** indirect dependencies\n\n`;
            
            // Group results by type
            const direct = [];
            const indirect = [];
            
            for (const result of results.results) {
              if (result.is_unmaintained) {
                if (result.is_direct) {
                  direct.push(result);
                } else {
                  indirect.push(result);
                }
              }
            }
            
            if (direct.length > 0) {
              comment += '### ðŸ”´ Direct Dependencies (Action Required)\n\n';
              comment += '| Package | Issue | Last Commit | URL |\n';
              comment += '|---------|-------|-------------|-----|\n';
              
              for (const result of direct) {
                const days = result.repo_info?.last_commit_days || result.days_since_update || 'N/A';
                const url = result.repo_info?.url || 'N/A';
                comment += `| \`${result.package}\` | ${result.details} | ${days} days ago | [View](${url}) |\n`;
              }
              comment += '\n';
            }
            
            if (indirect.length > 0) {
              comment += '### ðŸŸ¡ Indirect Dependencies (May require parent update)\n\n';
              comment += '| Package | Issue | Path | URL |\n';
              comment += '|---------|-------|------|-----|\n';
              
              for (const result of indirect) {
                const path = result.dependency_path?.join(' â†’ ') || 'N/A';
                const url = result.repo_info?.url || 'N/A';
                comment += `| \`${result.package}\` | ${result.details} | ${path} | [View](${url}) |\n`;
              }
              comment += '\n';
            }
            
            comment += '---\n';
            comment += '*Generated by [go-unmaintained](https://github.com/johnsaigle/go-unmaintained)*\n';
            
            // Post comment
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });
        env:
          RESULTS: ${{ steps.check.outputs.results-json }}
